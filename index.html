<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>國家防災日學習互動平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { background: #f5f7fa; }
    .topic-photo { width: 100%; max-width: 320px; height: 180px; object-fit: cover; border-radius: 12px; }
    .photo-ans-group {
      display: flex;
      align-items: flex-start;
      margin-bottom: 24px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 18px;
      gap: 20px;
    }
    .pdf-photo {
      width: 160px;
      height: 100px;
      object-fit: cover;
      border-radius: 10px;
      margin-left: 8px;
      box-shadow: 0 2px 8px #0002;
      border: 1px solid #eee;
      background: #fff;
    }
    .hidden { display: none; }
    @media (max-width: 600px){
      .photo-ans-group { flex-direction:column;}
      .pdf-photo { margin-left:0; margin-top:8px;}
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

<div id="main" class="w-full max-w-2xl mx-auto bg-white shadow-lg rounded-lg mt-6 p-6">
  <h1 class="text-2xl font-bold text-center mb-2 text-blue-900">國家防災日學習互動平台</h1>
  <p class="text-center text-gray-600 mb-6">依序完成每個主題的問題與照片上傳，最後可下載個人學習成果 PDF！</p>
  <div id="stepper" class="flex items-center justify-center mb-4">
    </div>
  <div id="topic-area">
    </div>
</div>

<div id="summary-area" class="w-full max-w-2xl mx-auto bg-white shadow-lg rounded-lg mt-6 p-6 hidden">
  <div id="summary-content"></div>
  <button onclick="downloadPDF()" class="mt-6 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 text-lg font-bold">匯出學習成果 PDF</button>
  <button onclick="location.reload()" class="mt-4 w-full bg-gray-300 text-gray-800 py-2 rounded">重新填寫</button>
</div>

<script>
const topics = [
  {
    title: "防災學習主題區",
    question: "當面臨突發地震時，下列哪一項不是正確的避難應變方式？",
    options: [
      "A. 就地尋找堅固桌椅下方蹲下掩護",
      "B. 第一時間跑到陽台或樓梯間",
      "C. 用手護住頭部，保護自身重要部位",
      "D. 等地震停止後再依指示有秩序撤離建築物"
    ],
    answer: 1,
    explanation: "地震時應先在安全處蹲下掩護，絕不應第一時間跑到陽台或樓梯間，這些地方危險且容易倒塌。"
  },
  {
    title: "市府災害防救宣導主題區",
    question: "臺北市政府在災害發生後，為協助民眾災後復原，下列哪一項不是市府單位可以提供的協助？",
    options: [
      "A. 災害損失稅捐減免",
      "B. 不動產交易安全諮詢",
      "C. 災民安置與心理輔導",
      "D. 免費贈送新房屋"
    ],
    answer: 3,
    explanation: "市府會提供多元協助如稅捐減免、安置及心理輔導，但不會直接免費贈送新房屋。"
  },
  {
    title: "環境永續主題區",
    question: "為了達到環境永續，下列哪一種日常行為最有助於減緩全球暖化及減少碳排放？",
    options: [
      "A. 多搭乘大眾運輸工具取代開車",
      "B. 常用一次性塑膠產品，因為方便",
      "C. 把可回收的物品直接丟進垃圾桶",
      "D. 夏天將冷氣溫度設定為最低並長時間使用"
    ],
    answer: 0,
    explanation: "搭乘大眾運輸可有效減少碳排放，是最有助於環境永續的日常行為。"
  },
  {
    title: "多元國際主題區",
    question: "國家防災日活動邀請多國團體共同參與，這麼做的主要目的是什麼？",
    options: [
      "A. 讓大家比賽誰的防災知識最強",
      "B. 讓不同國籍的人只關心自己國家的防災方式",
      "C. 促進不同文化之間的交流，學習各國防災經驗",
      "D. 減少台灣本地居民參與防災活動的機會"
    ],
    answer: 2,
    explanation: "多國參與是為了文化交流與互學，增強整體社會防災能力。"
  },
  {
    title: "國軍守護主題區",
    question: "關於國軍在天然災害中的角色，下列哪一項描述最正確？",
    options: [
      "A. 國軍僅負責戰爭時期的軍事行動，平時不參與災害救援",
      "B. 國軍平時結合地方政府，主動規劃並投入災害救援",
      "C. 國軍只負責維持秩序，不會動用專業救災部隊或器材",
      "D. 國軍在災害發生時比消防隊更晚抵達現場"
    ],
    answer: 1,
    explanation: "國軍會結合地方政府，主動投入救災，守護民眾安全。"
  },
  {
    title: "防災體驗主題區",
    question: "參加「地震求生72小時」體驗活動，學習的最重要核心觀念為何？",
    options: [
      "A. 只要有手機就不用準備其他物資",
      "B. 學會善用日常物品及具備自救能力",
      "C. 災害來臨時只依賴他人救援",
      "D. 災害發生時第一時間拍照上傳社群網站"
    ],
    answer: 1,
    explanation: "重點在學會自救與善用日常物資，提升面對災害的生存能力。"
  }
];

let current = 0;
let userAnswers = Array(topics.length).fill(null);
let photos = Array(topics.length).fill(null);

function renderStepper() {
  let html = "";
  for (let i = 0; i < topics.length; i++) {
    html += `<div class="w-8 h-8 rounded-full flex items-center justify-center ${current===i?"bg-blue-600 text-white":"bg-gray-200 text-gray-700"} font-bold mx-1">${i+1}</div>`;
  }
  document.getElementById('stepper').innerHTML = html;
}

function renderTopic() {
  renderStepper();
  const t = topics[current];
  let photoPreview = photos[current]
    ? `<img src="${photos[current]}" class="topic-photo my-2" id="photo-prev-${current}">`
    : `<img src="" class="topic-photo my-2 hidden" id="photo-prev-${current}">`;
  let options = "";
  for(let i=0; i<4; i++){
    let selected = userAnswers[current]===i ? 'ring-2 ring-blue-500' : '';
    options += `
      <button onclick="chooseAnswer(${i})" class="block w-full text-left bg-gray-100 hover:bg-blue-100 rounded px-4 py-2 my-1 ${selected}">
        ${t.options[i]}
      </button>`;
  }
  document.getElementById('topic-area').innerHTML = `
    <h2 class="text-lg font-bold text-blue-800 mb-1">${t.title}</h2>
    <div class="text-gray-800 mb-3">${t.question}</div>
    <div id="options">${options}</div>
    <div id="explanation" class="text-green-600 font-semibold mt-2 mb-2" style="min-height:1.8em"></div>
    <div class="mt-2">
      <label class="font-semibold">上傳照片（JPG/PNG，建議橫式）</label>
      <input type="file" accept="image/*" onchange="uploadPhoto(event,${current})" class="block my-2 w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      ${photoPreview}
    </div>
    <div class="mt-4 flex justify-between">
      <button ${current===0?'disabled':''} onclick="prevTopic()" class="px-5 py-2 bg-gray-200 rounded ${current===0?'opacity-50':''}">上一題</button>
      <button onclick="nextTopic()" class="px-5 py-2 bg-blue-600 text-white rounded">${current<topics.length-1?'下一題':'完成'}</button>
    </div>
  `;
  if(userAnswers[current]!=null){
    showExplanation();
  }
  if(photos[current]){
    document.getElementById(`photo-prev-${current}`).classList.remove('hidden');
  }
}

function chooseAnswer(idx){
  userAnswers[current] = idx;
  showExplanation();
  renderTopic();
}

function showExplanation(){
  let idx = userAnswers[current];
  let correct = topics[current].answer;
  let text = '';
  if(idx!==null){
    text = idx===correct ? "✔️ 答對了！" : "❌ 答錯了。";
    text += " " + topics[current].explanation;
  }
  document.getElementById('explanation').textContent = text;
}

// === 已更新為自動縮圖版本 ===
function uploadPhoto(e, topicIdx){
  const file = e.target.files[0];
  if(!file) return;
  if(!file.type.startsWith("image/")) return alert("僅支援圖片檔！");

  const reader = new FileReader();
  
  // 檔案讀取完成後觸發
  reader.onload = function(ev) {
    // 建立一個 Image 物件
    const img = new Image();
    
    // Image 物件載入 FileReader 讀取的原始圖片資料
    img.src = ev.target.result;
    
    // Image 物件成功載入圖片後觸發
    img.onload = function() {
      // --- 圖片縮放核心邏輯 ---
      const MAX_WIDTH = 1024; // 設定圖片最大寬度為 1024 像素
      const MAX_HEIGHT = 1024; // 設定圖片最大高度為 1024 像素

      let width = img.width;
      let height = img.height;

      // 按比例縮放
      if (width > height) {
        if (width > MAX_WIDTH) {
          height *= MAX_WIDTH / width;
          width = MAX_WIDTH;
        }
      } else {
        if (height > MAX_HEIGHT) {
          width *= MAX_HEIGHT / height;
          height = MAX_HEIGHT;
        }
      }
      
      // 建立一個看不見的 canvas
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      
      // 將圖片以新的尺寸繪製到 canvas 上
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      // 從 canvas 取得壓縮後的 JPEG 格式圖片資料 (品質 90%)
      const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
      
      // 將"縮小後"的圖片資料存起來
      photos[topicIdx] = dataUrl;
      
      // 重新渲染當前主題區塊，顯示縮小後的圖片預覽
      renderTopic();
    };
  };
  
  // 開始讀取檔案
  reader.readAsDataURL(file);
}

function prevTopic(){
  if(current > 0){
    current--;
    renderTopic();
  }
}

function nextTopic(){
  if(current < topics.length-1){
    current++;
    renderTopic();
  } else {
    showSummary();
  }
}

function showSummary(){
  document.getElementById('main').classList.add('hidden');
  document.getElementById('summary-area').classList.remove('hidden');
  
  // 產生學習成果總覽
  let html = `<h2 class="text-xl font-bold text-center mb-6 text-blue-900">學習成果總覽</h2>`;
  for(let i=0;i<topics.length;i++){
    const userAnswerText = userAnswers[i] !== null ? topics[i].options[userAnswers[i]] : '未作答';
    html += `
      <div class="photo-ans-group">
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-blue-800">${i+1}. ${topics[i].title}</h3>
          <div class="text-gray-700 mt-2 mb-1">${topics[i].question}</div>
          <div class="mb-1">你的答案：<span class="${userAnswers[i]===topics[i].answer?'text-green-700':'text-red-700'} font-semibold">${userAnswerText}</span></div>
          <div class="mb-1">正確答案：<span class="font-semibold">${topics[i].options[topics[i].answer]}</span></div>
          <div class="mb-1 text-gray-600 text-sm">${topics[i].explanation}</div>
        </div>
        ${photos[i]?`<img src="${photos[i]}" class="pdf-photo">`:`<div class='pdf-photo flex items-center justify-center text-sm text-gray-400 italic bg-gray-50' style='width:160px; height:100px;'>（未上傳照片）</div>`}
      </div>
    `;
  }
  document.getElementById('summary-content').innerHTML = html;
}

function downloadPDF(){
  const summary = document.getElementById('summary-content');
  // 暫時移除陰影以利PDF生成
  const images = summary.querySelectorAll('.pdf-photo');
  images.forEach(img => img.style.boxShadow = 'none');

  html2pdf(summary, {
    margin:       0.5,
    filename:     `國家防災日學習成果.pdf`,
    image:        { type: 'jpeg', quality: 0.95 },
    html2canvas:  { scale: 2, useCORS: true },
    jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
  }).then(() => {
    // PDF生成後恢復陰影
    images.forEach(img => img.style.boxShadow = '0 2px 8px #0002');
  });
}

window.onload = function(){
  renderTopic();
}
</script>
</body>
</html>
