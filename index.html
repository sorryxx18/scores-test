<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>國家防災日 學習成果</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            max-width: 900px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .topic-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .option-btn {
            display: block;
            width: 100%;
            text-align: left;
            background: white;
            border: 2px solid #e5e7eb;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .option-btn:hover {
            border-color: #667eea;
            background: #f0f9ff;
        }
        .option-btn.selected {
            border-color: #667eea;
            background: #eff6ff;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .stepper-item {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .stepper-item.active {
            background: #667eea;
            color: white;
        }
        .stepper-item.completed {
            background: #10b981;
            color: white;
        }
        .stepper-item.pending {
            background: white;
            color: #6b7280;
            border: 2px solid #d1d5db;
        }
        .photo-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 16px 0;
        }
        .photo-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #34d399);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        #summary-area {
            display: none;
        }
        #camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .camera-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            max-width: 90vw;
            max-height: 90vh;
        }
        #camera-video {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
        }
        #camera-canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="main-quiz">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="font-size: 2.5rem; font-weight: bold; color: #1e40af; margin-bottom: 10px;">
                    🛡️ 國家防災日 學習成果
                </h1>
                <p style="color: #6b7280; font-size: 1.1rem;">請完成六大主題問題與照片，最後匯出專屬成果 PDF</p>
            </div>
            
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
            </div>
            
            <div id="stepper" style="display: flex; justify-content: center; margin-bottom: 30px;"></div>
            
            <div id="quiz-content"></div>
        </div>
    </div>

    <div id="summary-area" class="main-container">
        <h2 style="text-align: center; color: #1e40af; margin-bottom: 30px; font-size: 2rem;">學習成果總覽</h2>
        <div id="summary-content"></div>
        <button onclick="downloadPDF()" class="btn btn-primary" style="width: 100%; margin-top: 20px; font-size: 1.1rem;">
            📄 匯出學習成果 PDF
        </button>
        <button onclick="location.reload()" class="btn" style="width: 100%; margin-top: 10px; background: #f3f4f6;">
            🔄 重新填寫
        </button>
    </div>

    <div id="camera-modal">
        <div class="camera-container">
            <h3 style="margin-bottom: 15px;">📷 拍攝照片</h3>
            <video id="camera-video" autoplay playsinline></video>
            <canvas id="camera-canvas"></canvas>
            <div style="margin-top: 15px;">
                <button onclick="capturePhoto()" class="btn btn-primary">📸 拍照</button>
                <button onclick="closeCameraModal()" class="btn" style="background: #ef4444; color: white; margin-left: 10px;">❌ 取消</button>
            </div>
        </div>
    </div>

    <script>
        const topics = [
            {
                title: "防災學習主題區",
                question: "當面臨突發地震時，下列哪一項不是正確的避難應變方式？",
                options: [
                    "A. 就地尋找堅固桌椅下方蹲下掩護",
                    "B. 第一時間跑到陽台或樓梯間",
                    "C. 用手護住頭部，保護自身重要部位",
                    "D. 等地震停止後再依指示有秩序撤離建築物"
                ],
                answer: 1,
                explanation: "地震時應先在安全處蹲下掩護，絕不應第一時間跑到陽台或樓梯間，這些地方危險且容易倒塌。"
            },
            {
                title: "市府災害防救宣導主題區",
                question: "臺北市政府在災害發生後，為協助民眾災後復原，下列哪一項不是市府單位可以提供的協助？",
                options: [
                    "A. 災害損失稅捐減免",
                    "B. 不動產交易安全諮詢",
                    "C. 災民安置與心理輔導",
                    "D. 免費贈送新房屋"
                ],
                answer: 3,
                explanation: "市府會提供多元協助如稅捐減免、安置及心理輔導，但不會直接免費贈送新房屋。"
            },
            {
                title: "環境永續主題區",
                question: "為了達到環境永續，下列哪一種日常行為最有助於減緩全球暖化及減少碳排放？",
                options: [
                    "A. 多搭乘大眾運輸工具取代開車",
                    "B. 常用一次性塑膠產品，因為方便",
                    "C. 把可回收的物品直接丟進垃圾桶",
                    "D. 夏天將冷氣溫度設定為最低並長時間使用"
                ],
                answer: 0,
                explanation: "搭乘大眾運輸可有效減少碳排放，是最有助於環境永續的日常行為。"
            },
            {
                title: "多元國際主題區",
                question: "國家防災日活動邀請多國團體共同參與，這麼做的主要目的是什麼？",
                options: [
                    "A. 讓大家比賽誰的防災知識最強",
                    "B. 讓不同國籍的人只關心自己國家的防災方式",
                    "C. 促進不同文化之間的交流，學習各國防災經驗",
                    "D. 減少台灣本地居民參與防災活動的機會"
                ],
                answer: 2,
                explanation: "多國參與是為了文化交流與互學，增強整體社會防災能力。"
            },
            {
                title: "國軍守護主題區",
                question: "關於國軍在天然災害中的角色，下列哪一項描述最正確？",
                options: [
                    "A. 國軍僅負責戰爭時期的軍事行動，平時不參與災害救援",
                    "B. 國軍平時結合地方政府，主動規劃並投入災害救援",
                    "C. 國軍只負責維持秩序，不會動用專業救災部隊或器材",
                    "D. 國軍在災害發生時比消防隊更晚抵達現場"
                ],
                answer: 1,
                explanation: "國軍會結合地方政府，主動投入救災，守護民眾安全。"
            },
            {
                title: "防災體驗主題區",
                question: "參加「地震求生72小時」體驗活動，學習的最重要核心觀念為何？",
                options: [
                    "A. 只要有手機就不用準備其他物資",
                    "B. 學會善用日常物品及具備自救能力",
                    "C. 災害來臨時只依賴他人救援",
                    "D. 災害發生時第一時間拍照上傳社群網站"
                ],
                answer: 1,
                explanation: "重點在學會自救與善用日常物資，提升面對災害的生存能力。"
            }
        ];

        let currentQuestion = 0;
        let userAnswers = Array(topics.length).fill(null);
        let photos = Array(topics.length).fill(null);

        function updateProgress() {
            const answeredQuestions = userAnswers.filter(a => a !== null).length;
            const uploadedPhotos = photos.filter(p => p !== null).length;
            const totalProgress = (answeredQuestions + uploadedPhotos) / (topics.length * 2) * 100;
            document.getElementById('progress-fill').style.width = totalProgress + '%';
        }

        function renderStepper() {
            let html = '';
            for (let i = 0; i < topics.length; i++) {
                const isActive = currentQuestion === i;
                const isCompleted = userAnswers[i] !== null && photos[i] !== null;
                const className = isActive ? 'active' : isCompleted ? 'completed' : 'pending';
                html += `<div class="stepper-item ${className}">${i + 1}</div>`;
            }
            document.getElementById('stepper').innerHTML = html;
        }

        function renderQuestion() {
            const topic = topics[currentQuestion];
            let optionsHtml = '';
            
            for (let i = 0; i < topic.options.length; i++) {
                const selected = userAnswers[currentQuestion] === i ? 'selected' : '';
                optionsHtml += `<button class="option-btn ${selected}" onclick="selectAnswer(${i})">${topic.options[i]}</button>`;
            }

            const photoDisplay = photos[currentQuestion] ? 
                `<img src="${photos[currentQuestion]}" class="photo-preview" style="display: block; margin: 10px auto;">` : 
                '<div style="color: #9ca3af; font-style: italic; margin: 10px 0;">尚未上傳照片</div>';

            document.getElementById('quiz-content').innerHTML = `
                <div class="topic-card">
                    <h3 style="color: #1e40af; font-size: 1.3rem; margin-bottom: 15px;">
                        ${currentQuestion + 1}. ${topic.title}
                    </h3>
                    <p style="margin-bottom: 20px; line-height: 1.6; font-size: 1.05rem;">${topic.question}</p>
                    ${optionsHtml}
                    <div id="explanation" style="margin-top: 15px; min-height: 20px;"></div>
                    
                    <div class="photo-area">
                        <p style="margin-bottom: 15px; font-weight: 600; color: #374151;">📸 上傳學習照片</p>
                        <input type="file" accept="image/*" onchange="uploadPhoto(event)" style="margin-bottom: 15px;">
                        <div>
                            <button onclick="openCamera()" class="btn" style="background: #10b981; color: white; margin-right: 10px;">📷 即時拍照</button>
                            ${photos[currentQuestion] ? '<button onclick="removePhoto()" class="btn" style="background: #ef4444; color: white;">🗑️ 移除照片</button>' : ''}
                        </div>
                        ${photoDisplay}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 25px;">
                        <button onclick="prevQuestion()" ${currentQuestion === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} class="btn" style="background: #f3f4f6;">← 上一題</button>
                        <button onclick="nextQuestion()" class="btn btn-primary">${currentQuestion === topics.length - 1 ? '完成測驗 ✓' : '下一題 →'}</button>
                    </div>
                </div>
            `;
            
            renderStepper();
            updateProgress();
            showExplanation();
        }

        function selectAnswer(index) {
            userAnswers[currentQuestion] = index;
            renderQuestion();
        }

        function showExplanation() {
            const explanationDiv = document.getElementById('explanation');
            if (userAnswers[currentQuestion] !== null) {
                const isCorrect = userAnswers[currentQuestion] === topics[currentQuestion].answer;
                const icon = isCorrect ? '✅' : '❌';
                const color = isCorrect ? '#059669' : '#dc2626';
                const bgColor = isCorrect ? '#f0fdf4' : '#fef2f2';
                const text = isCorrect ? '答對了！' : '答錯了。';
                explanationDiv.innerHTML = `
                    <div style="background: ${bgColor}; border-left: 4px solid ${color}; padding: 15px; border-radius: 6px;">
                        <div style="color: ${color}; font-weight: 600; margin-bottom: 8px;">${icon} ${text}</div>
                        <div style="line-height: 1.5;">${topics[currentQuestion].explanation}</div>
                    </div>
                `;
            } else {
                explanationDiv.innerHTML = '';
            }
        }

        function uploadPhoto(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photos[currentQuestion] = e.target.result;
                    renderQuestion();
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto() {
            photos[currentQuestion] = null;
            renderQuestion();
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (userAnswers[currentQuestion] === null) {
                alert('請先回答問題再進入下一題！');
                return;
            }
            if (photos[currentQuestion] === null) {
                alert('請先上傳照片再進入下一題！');
                return;
            }
            
            if (currentQuestion < topics.length - 1) {
                currentQuestion++;
                renderQuestion();
            } else {
                showSummary();
            }
        }

        function showSummary() {
            document.getElementById('main-quiz').parentElement.style.display = 'none';
            document.getElementById('summary-area').style.display = 'block';
            
            const correctCount = userAnswers.filter((answer, index) => answer === topics[index].answer).length;
            const percentage = Math.round((correctCount / topics.length) * 100);
            
            let summaryHtml = `
                <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
                    <h3 style="margin: 0 0 8px 0; font-size: 1.8rem;">🛡️ 國家防災日學習成果</h3>
                    <p style="margin: 0 0 8px 0; font-size: 1.1rem;">台北市政府消防局</p>
                    <p style="margin: 0; opacity: 0.9;">${new Date().toLocaleDateString('zh-TW')} | 成績：${correctCount}/${topics.length} 題正確 (${percentage}%)</p>
                </div>
            `;
            
            for (let i = 0; i < topics.length; i++) {
                const isCorrect = userAnswers[i] === topics[i].answer;
                const userAnswer = topics[i].options[userAnswers[i]];
                const correctAnswer = topics[i].options[topics[i].answer];
                
                summaryHtml += `
                    <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: white;">
                        <div style="display: flex; gap: 20px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h4 style="color: #1e40af; margin: 0 0 10px 0; font-size: 1.2rem;">
                                    ${i + 1}. ${topics[i].title}
                                </h4>
                                <p style="margin: 0 0 15px 0; line-height: 1.6;">${topics[i].question}</p>
                                <div style="margin-bottom: 10px;">
                                    <strong>你的答案：</strong>
                                    <span style="color: ${isCorrect ? '#059669' : '#dc2626'}; font-weight: 600;">${userAnswer}</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>正確答案：</strong>
                                    <span style="color: #059669; font-weight: 600;">${correctAnswer}</span>
                                </div>
                                <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 6px;">
                                    <strong>💡 解析：</strong>${topics[i].explanation}
                                </div>
                            </div>
                            <div style="flex-shrink: 0;">
                                ${photos[i] ? 
                                    `<img src="${photos[i]}" style="width: 180px; height: 135px; object-fit: contain; border: 2px solid #e5e7eb; border-radius: 8px; background: white;">` : 
                                    `<div style="width: 180px; height: 135px; border: 2px dashed #d1d5db; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #9ca3af; text-align: center; font-size: 0.9rem;">📷<br>未上傳照片</div>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('summary-content').innerHTML = summaryHtml;
        }

        function downloadPDF() {
            const element = document.getElementById('summary-content');
            html2pdf(element, {
                margin: 0.5,
                filename: '國家防災日學習成果.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            });
        }

        // 拍照功能
        let cameraStream = null;

        function openCamera() {
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-video');
            
            modal.style.display = 'flex';
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(stream => {
                cameraStream = stream;
                video.srcObject = stream;
            })
            .catch(err => {
                alert('無法開啟攝影機，請使用檔案上傳功能');
                closeCameraModal();
            });
        }

        function closeCameraModal() {
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-video');
            
            modal.style.display = 'none';
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            video.srcObject = null;
        }

        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            photos[currentQuestion] = canvas.toDataURL('image/jpeg', 0.8);
            closeCameraModal();
            renderQuestion();
        }

        // 初始化
        window.onload = function() {
            renderQuestion();
        };
    </script>
</body>
</html>
