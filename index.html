<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>國家防災日 學習成果</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      background: #f1f5f9; /* slate-100 */
      font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
    }
    /* Red theme based on mascot */
    .main-header-bg {
      background-color: #d32f2f; /* A strong, fire-department red */
      color: #fff;
      letter-spacing: 2px;
    }
    .pdf-photo {
      width: 150px;
      height: 90px;
      object-fit: cover;
      border-radius: 8px;
      margin-left: 16px;
      box-shadow: 0 4px 12px #00000022;
      border: 1px solid #e2e8f0; /* slate-200 */
      background: #fff;
    }
    .question-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 44px;
      border-top-width: 4px;
      border-color: var(--topic-color, #9ca3af); /* gray-400 */
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .summary-card {
       display: flex;
       align-items: flex-start;
       gap: 18px;
    }
    .topic-title { font-size: 1.1em; color: var(--topic-color, #d32f2f); font-weight: 700; letter-spacing: 1px;}
    /* Topic Colors to match the red/gray theme */
    .topic-1 { --topic-color: #ef5350; } /* red-400 */
    .topic-2 { --topic-color: #ff7043; } /* deep-orange-400 */
    .topic-3 { --topic-color: #ffca28; } /* amber-400 */
    .topic-4 { --topic-color: #78909c; } /* blue-gray-400 */
    .topic-5 { --topic-color: #5d4037; } /* brown-700 */
    .topic-6 { --topic-color: #424242; } /* gray-800 */

    .page-break { page-break-after: always; }

    #summary-area, #summary-content {
      max-width: 830px;
      margin: auto;
      background: #fff;
      box-sizing: border-box;
      padding: 32px 24px 18px 24px;
      border-radius: 15px;
      box-shadow: 0 4px 12px #d32f2f18; /* shadow reflects new theme color */
    }
    @media (max-width: 700px){
      #summary-area, #summary-content { padding: 16px; }
      .summary-card { flex-direction: column; }
      .pdf-photo { margin-left: 0; margin-top: 8px; }
    }
    .logo { height: 50px; }
    .qnum {
      background-color: var(--topic-color, #d32f2f);
      color: #fff;
      border-radius: 6px;
      font-weight: bold;
      padding: 3px 10px;
      margin-right: 10px;
      font-size: 0.9em;
    }
    .option-btn {
        transition: background-color 0.2s, border-color 0.2s;
        border: 1px solid #e5e7eb; /* gray-200 */
    }
    /* Selection color */
    .option-btn.selected {
        background-color: #ffebee; /* red-50 */
        border-color: #d32f2f; /* red-600 */
        font-weight: 600;
    }
    .main-btn {
      transition: background-color 0.2s ease-in-out;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

<script>
// Correct, working Base64 for the Taipei City Fire Department logo.
const base64Logo = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAbFBMVEX////tHCTsAAD84eD+8/L+9/b70tH1o6T5vbrsAADEZ235xMXuTE72s7Tyb3HwhIf2rK7+7u/sERv82dr5wsT5ycncOj/pra/sCgzssLbERkfmaWvkeHvfbm/0k5XygoXqZmfukpPqX1/wgn4W38aVAAADfUlEQVR4nO2dC3OaQBCGUyqggh5QxAcVxf//pSfe0pCkdPaylM3sObN3p2kWFnfXbTYVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4PzK7fJ2ZfT2dJbZ8P5m1S2ZbV3dP1h/yvM3uVq/M3mJ2t2x/k8xWZva3pLePzG4z+/Uw27Nq+zNzYxsbk2M3N2dOto+Y2d3Mru9ZXd+8nBgzs5nN2Zct6y85I1m9ns1OzVz/eMbsVmakx+K8+91uNuNuNuNeP/Mv/f2+s5eYWa5m1zOrV5y1x3I2xmtmN/pD6W+pY/E8bua3D8zW1s1m1r9na/YgM7tld5g135v19/b29k7mM/sHs3vN3s5sW/aDmd0zW1m3fn+zm+1oDCf4I/O3MfBfF87WzA/D+f3MzrY+fnvD+bfwT+b79fXm7pL3s6vM7HdlTw+Z3bE7n/35nE0Wc6b+jPI3s7t3Duf3+2//3o/y50v2fGbvM/uHzO4ze3S31fD5uM8vM7uL2Y1333w/mM0uYvab2cVmz3P+76d/Zzbb39/b/fNn/R/+I/M+sz/fMfvV7E5mH1h/3f2Vv7f794efs/9vZu+wOz/8m/l1zOz04Yf/hM5sZ/+z+x+Z3Xf//kYn02/d/p75NfNvZu+wO//sP8s/ZnaPzJ7c7R+Z/eb/fGbXw/8/s/P/uPvT+f3b39v9k/k/+13/4r8zf+/f/N6d/Uv2x+Z3/s//xvzdv2N/Y/b3/u//yfzW/P4X+7e//8X+k/lf/17/H/k/+z/2F/Z/9x/a37//44fy5//s79n/8+P8b/ev/sP58//sf979k/lf+1/+Uv6v/Nf9n//c/Lf9D/e3/Wf/w//Z/4t/2v+r/xv/5n/i3/3/0v+V/53/7n/j//m/i3/R/+t/K//m/+1/9f/Xv6v/1f+a/+v/Pf+f/W/+v/qf+v/W/9f/u/+P/l//r/5//s//R/9//T/4//D/4v/b//P/r//X/+f+n//v/V/+P/q//X/+v/X/+f+l/9P/h/+n/R//P/7/+LwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD43/wCRGylhQqFApEAAAAASUVORK5CYII=";
</script>

<div id="main" class="w-full max-w-3xl mx-auto bg-white shadow-xl rounded-2xl mt-6 p-6 md:p-8">
  <div class="flex flex-col items-center mb-6">
    <img id="mainLogo" src="" class="logo mb-4" alt="Logo">
    <h1 class="text-3xl font-bold text-center mb-2 main-header-bg rounded-lg p-3 shadow-md">國家防災日 學習成果</h1>
  </div>
  <p class="text-center text-gray-600 mb-6">請完成六大主題問題與照片，最後匯出專屬成果 PDF。</p>
  <div id="stepper" class="flex items-center justify-center mb-6"></div>
  <div id="topic-area"></div>
</div>

<div id="summary-area" style="display:none;">
  <div class="flex flex-col items-center mb-5">
    <img id="pdfLogo" src="" class="logo mb-3" alt="Logo">
    <div class="text-2xl font-bold main-header-bg p-3 rounded-lg shadow-md mb-3">學習成果總覽</div>
    <div class="text-gray-700 text-base" style="letter-spacing:1px;">臺北市政府消防局 國家防災日</div>
  </div>
  <div id="summary-content"></div>
  <button onclick="downloadPDF()" class="mt-8 w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 text-lg font-bold shadow-md main-btn">匯出學習成果 PDF</button>
  <button onclick="location.reload()" class="mt-3 w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 main-btn">重新填寫</button>
</div>

<script>
const topics = [
  {
    title: "防災學習主題區",
    tclass: "topic-1",
    question: "當面臨突發地震時，下列哪一項不是正確的避難應變方式？",
    options: [
      "A. 就地尋找堅固桌椅下方蹲下掩護",
      "B. 第一時間跑到陽台或樓梯間",
      "C. 用手護住頭部，保護自身重要部位",
      "D. 等地震停止後再依指示有秩序撤離建築物"
    ],
    answer: 1,
    explanation: "地震時應先在安全處蹲下掩護，絕不應第一時間跑到陽台或樓梯間，這些地方危險且容易倒塌。"
  },
  {
    title: "市府災害防救宣導主題區",
    tclass: "topic-2",
    question: "臺北市政府在災害發生後，為協助民眾災後復原，下列哪一項不是市府單位可以提供的協助？",
    options: [
      "A. 災害損失稅捐減免",
      "B. 不動產交易安全諮詢",
      "C. 災民安置與心理輔導",
      "D. 免費贈送新房屋"
    ],
    answer: 3,
    explanation: "市府會提供多元協助如稅捐減免、安置及心理輔導，但不會直接免費贈送新房屋。"
  },
  {
    title: "環境永續主題區",
    tclass: "topic-3",
    question: "為了達到環境永續，下列哪一種日常行為最有助於減緩全球暖化及減少碳排放？",
    options: [
      "A. 多搭乘大眾運輸工具取代開車",
      "B. 常用一次性塑膠產品，因為方便",
      "C. 把可回收的物品直接丟進垃圾桶",
      "D. 夏天將冷氣溫度設定為最低並長時間使用"
    ],
    answer: 0,
    explanation: "搭乘大眾運輸可有效減少碳排放，是最有助於環境永續的日常行為。"
  },
  {
    title: "多元國際主題區",
    tclass: "topic-4",
    question: "國家防災日活動邀請多國團體共同參與，這麼做的主要目的是什麼？",
    options: [
      "A. 讓大家比賽誰的防災知識最強",
      "B. 讓不同國籍的人只關心自己國家的防災方式",
      "C. 促進不同文化之間的交流，學習各國防災經驗",
      "D. 減少台灣本地居民參與防災活動的機會"
    ],
    answer: 2,
    explanation: "多國參與是為了文化交流與互學，增強整體社會防災能力。"
  },
  {
    title: "國軍守護主題區",
    tclass: "topic-5",
    question: "關於國軍在天然災害中的角色，下列哪一項描述最正確？",
    options: [
      "A. 國軍僅負責戰爭時期的軍事行動，平時不參與災害救援",
      "B. 國軍平時結合地方政府，主動規劃並投入災害救援",
      "C. 國軍只負責維持秩序，不會動用專業救災部隊或器材",
      "D. 國軍在災害發生時比消防隊更晚抵達現場"
    ],
    answer: 1,
    explanation: "國軍會結合地方政府，主動投入救災，守護民眾安全。"
  },
  {
    title: "防災體驗主題區",
    tclass: "topic-6",
    question: "參加「地震求生72小時」體驗活動，學習的最重要核心觀念為何？",
    options: [
      "A. 只要有手機就不用準備其他物資",
      "B. 學會善用日常物品及具備自救能力",
      "C. 災害來臨時只依賴他人救援",
      "D. 災害發生時第一時間拍照上傳社群網站"
    ],
    answer: 1,
    explanation: "重點在學會自救與善用日常物資，提升面對災害的生存能力。"
  }
];

let current = 0;
let userAnswers = Array(topics.length).fill(null);
let photos = Array(topics.length).fill(null);

function renderStepper() {
  let html = "";
  for (let i = 0; i < topics.length; i++) {
    const isCompleted = userAnswers[i] !== null && photos[i] !== null;
    const isActive = current === i;
    let stepClass = "bg-gray-200 text-gray-700";
    if(isActive) {
        // New active color
        stepClass = "bg-red-600 text-white ring-2 ring-offset-2 ring-red-500";
    } else if (isCompleted) {
        stepClass = "bg-green-500 text-white";
    }
    html += `<div class="w-8 h-8 rounded-full flex items-center justify-center ${stepClass} font-bold mx-1 transition-all">${i+1}</div>`;
    if (i < topics.length - 1) {
      html += `<div class="flex-1 h-1 bg-gray-200"></div>`;
    }
  }
  document.getElementById('stepper').innerHTML = `<div class="w-full flex items-center">${html}</div>`;
}

function renderTopic() {
  renderStepper();
  const t = topics[current];
  let photoPreview = photos[current]
    ? `<img src="${photos[current]}" class="pdf-photo my-2 block" id="photo-prev-${current}">`
    : `<img src="" class="pdf-photo my-2 hidden" id="photo-prev-${current}">`;
  let options = "";
  for(let i=0; i<4; i++){
    let selectedClass = userAnswers[current] === i ? 'selected' : '';
    // New hover color
    options += `
      <button onclick="chooseAnswer(${i})" class="block w-full text-left bg-white hover:bg-red-50 rounded-lg px-4 py-3 my-2 option-btn ${selectedClass}">
        ${t.options[i]}
      </button>`;
  }
  document.getElementById('topic-area').innerHTML = `
    <div class="question-card ${t.tclass}">
      <div>
        <h2 class="topic-title mb-3"><span class="qnum">${current+1}</span>${t.title}</h2>
        <div class="text-gray-800 text-base mb-4 leading-relaxed">${t.question}</div>
        <div id="options">${options}</div>
        <div id="explanation" class="text-green-700 font-semibold mt-3 mb-3 p-3 rounded-lg bg-green-50" style="min-height:3em; display:none;"></div>
        <div class="mt-4 border-t pt-4">
          <label class="font-semibold text-gray-700">上傳活動照片 (JPG/PNG)</label>
           <input type="file" accept="image/jpeg, image/png" onchange="uploadPhoto(event, ${current})" class="block my-2 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
          ${photoPreview}
        </div>
      </div>
    </div>
    <div class="mt-6 flex justify-between">
      <button ${current===0?'disabled':''} onclick="prevTopic()" class="px-6 py-2 bg-gray-200 rounded-lg ${current===0?'opacity-50 cursor-not-allowed':'hover:bg-gray-300'} main-btn">上一題</button>
      <button onclick="nextTopic()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 main-btn shadow">${current<topics.length-1?'下一題':'完成作答'}</button>
    </div>
  `;
  if(userAnswers[current] !== null){
    showExplanation();
  }
}

function chooseAnswer(idx){
  userAnswers[current] = idx;
  renderTopic();
}

function showExplanation(){
  let idx = userAnswers[current];
  let correct = topics[current].answer;
  let expDiv = document.getElementById('explanation');
  let text = '';
  if(idx !== null){
    if (idx === correct) {
        text = "✔️ 答對了！ " + topics[current].explanation;
        expDiv.className = "text-green-800 font-semibold mt-3 mb-3 p-3 rounded-lg bg-green-100";
    } else {
        text = "❌ 答錯了。 " + topics[current].explanation;
        expDiv.className = "text-red-800 font-semibold mt-3 mb-3 p-3 rounded-lg bg-red-100";
    }
    expDiv.textContent = text;
    expDiv.style.display = 'block';
  }
}

function uploadPhoto(e, topicIdx){
  const file = e.target.files[0];
  if(!file) return;
  if(!file.type.startsWith("image/")) {
    alert("請上傳圖片格式檔案 (JPG, PNG)！");
    return;
  }
  const reader = new FileReader();
  reader.onload = function(ev){
    photos[topicIdx] = ev.target.result;
    document.getElementById(`photo-prev-${topicIdx}`).src = ev.target.result;
    document.getElementById(`photo-prev-${topicIdx}`).classList.remove('hidden');
    renderStepper();
  };
  reader.readAsDataURL(file);
}

function prevTopic(){
  if(current > 0){
    current--;
    renderTopic();
  }
}
function nextTopic(){
  if (userAnswers[current] === null) {
    alert('請先回答問題再前往下一題！');
    return;
  }
  if (photos[current] === null) {
    alert('請先上傳照片再前往下一題！');
    return;
  }
  if(current < topics.length-1){
    current++;
    renderTopic();
  } else {
    showSummary();
  }
}

function showSummary(){
  document.getElementById('main').style.display = "none";
  document.getElementById('summary-area').style.display = "block";
  document.getElementById('pdfLogo').src = base64Logo;
  let html = '';
  for(let i=0;i<topics.length;i++){
    const isCorrect = userAnswers[i] === topics[i].answer;
    const answerText = userAnswers[i] !== null ? topics[i].options[userAnswers[i]] : '未作答';

    html += `
      <div class="question-card summary-card ${topics[i].tclass}">
        <div style="flex:1;">
          <h3 class="topic-title mb-2"><span class="qnum">${i+1}</span>${topics[i].title}</h3>
          <p class="text-gray-800 mb-2 font-semibold">${topics[i].question}</p>
          <p class="mb-1 text-sm">你的答案：<span style="font-weight:600; color:${isCorrect ? '#166534' : '#991b1b'};">${answerText}</span></p>
          <p class="mb-1 text-sm">正確答案：<span class="font-semibold text-gray-700">${topics[i].options[topics[i].answer]}</span></p>
          <p class="text-xs text-gray-500 mt-2">${topics[i].explanation}</p>
        </div>
        ${photos[i] ? `<img src="${photos[i]}" class="pdf-photo">`:"<div class='text-sm text-gray-400 italic self-center'>（未上傳照片）</div>"}
      </div>
    `;
    if ((i + 1) % 3 === 0 && i < topics.length - 1) {
      html += `<div class="page-break"></div>`;
    }
  }
  document.getElementById('summary-content').innerHTML = html;
}

function downloadPDF(){
  window.scrollTo(0,0);
  const summaryContent = document.getElementById('summary-content');
  const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  
  setTimeout(function(){
    html2pdf(summaryContent, {
      margin:       0.5,
      filename:     `國家防災日學習成果_${timestamp}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true, scrollY: -window.scrollY },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    });
  }, 200);
}

window.onload = function(){
  document.getElementById('mainLogo').src = base64Logo;
  renderTopic();
}
</script>
</body>
</html>
