<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地端 消防體測數據分析應用程式</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-bg: #f0f2f5; --sidebar-bg: #001529; --header-bg: #ffffff; --card-bg: #ffffff; --primary-text: #333; --secondary-text: #666; --primary-blue: #1890ff; --border-color: #e8e8e8; --color-excellent: #389e0d; --color-good: #1890ff; --color-pass: #faad14; --color-fail: #d4380d; --color-female: #722ed1; --color-male: #1890ff; --success-green: #28a745;}
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--primary-bg); color: var(--primary-text); }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .setup-section { background: var(--card-bg); padding: 24px; border-radius: 8px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .setup-section h1 { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .data-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .data-inputs textarea { width: 100%; height: 200px; padding: 10px; font-family: monospace; font-size: 12px; border: 1px solid var(--border-color); border-radius: 4px; }
        .process-button { width: 100%; padding: 15px; font-size: 18px; font-weight: 700; background-color: var(--success-green); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .process-button:hover { background-color: #218838; }
        .dashboard-grid { display: none; grid-template-columns: repeat(12, 1fr); gap: 24px; }
        .grid-item { background-color: var(--card-bg); border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .full-width { grid-column: 1 / -1; }
        .col-8 { grid-column: span 8; }
        .col-4 { grid-column: span 4; }
        .card-title { margin: 0 0 20px 0; font-size: 18px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }
        .kpi-card { display: flex; align-items: center; gap: 16px; padding: 16px; }
        .kpi-card .icon { font-size: 28px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .kpi-card .value { font-size: 24px; font-weight: 700; }
        .kpi-card .label { font-size: 14px; color: var(--secondary-text); }
        #age-chart-container, #leaderboard-table, #comparison-chart-container { min-height: 350px; display: flex; flex-direction: column; }
        .chart-container-inner { flex-grow: 1; position: relative; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table thead th { background-color: #fafafa; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge.excellent { background: rgba(56, 158, 13, 0.1); color: var(--color-excellent); }
        .badge.good { background: rgba(24, 144, 255, 0.1); color: var(--color-good); }
        .badge.pass { background: rgba(250, 173, 20, 0.1); color: var(--color-pass); }
        .badge.fail { background: rgba(212, 56, 13, 0.1); color: var(--color-fail); }
        .header-controls { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 16px 24px; border-radius: 8px; margin-bottom: 24px;}
    </style>
</head>
<body>
    <div class="container">
        <section class="setup-section">
            <h1><i class="fa-solid fa-rocket"></i>本地端數據分析工具</h1>
            <div class="data-inputs">
                <div>
                    <h2>步驟1：貼上【成績輸入.csv】內容</h2>
                    <textarea id="input-data" placeholder="請將 成績輸入.csv 的全部內容貼在此處..."></textarea>
                </div>
                <div>
                    <h2>步驟2：貼上【新版換算表.csv】內容</h2>
                    <textarea id="conversion-data" placeholder="請將 新版換算表.csv 的全部內容貼在此處..."></textarea>
                </div>
            </div>
            <button id="process-button" class="process-button"><i class="fa-solid fa-cogs"></i> 產生分析報告</button>
        </section>

        <section id="dashboard" class="dashboard-grid">
            <div class="full-width header-controls">
                <h1 style="margin:0;">消防體能測驗總覽</h1>
                <div>
                    <label for="test-select"><strong>分析項目：</strong></label>
                    <select id="test-select" style="padding: 8px 12px; border-radius: 4px; border: 1px solid #d9d9d9;"></select>
                </div>
            </div>
            <div class="grid-item full-width">
                <h2 class="card-title"><i class="fa-solid fa-award"></i>關鍵績效指標 (KPI) - 綜合評級</h2>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="icon" style="color:var(--color-excellent); background:rgba(56,158,13,0.1);"><i class="fa-solid fa-crown"></i></div><div><div class="label">菁英級</div><div id="kpi-excellent" class="value"></div></div></div>
                    <div class="kpi-card"><div class="icon" style="color:var(--color-good); background:rgba(24,144,255,0.1);"><i class="fa-solid fa-thumbs-up"></i></div><div><div class="label">良好級</div><div id="kpi-good" class="value"></div></div></div>
                    <div class="kpi-card"><div class="icon" style="color:var(--color-pass); background:rgba(250,173,20,0.1);"><i class="fa-solid fa-check"></i></div><div><div class="label">合格級</div><div id="kpi-pass" class="value"></div></div></div>
                    <div class="kpi-card"><div class="icon" style="color:var(--color-fail); background:rgba(212,56,13,0.1);"><i class="fa-solid fa-person-running"></i></div><div><div class="label">待加強</div><div id="kpi-fail" class="value"></div></div></div>
                </div>
            </div>
            <div class="grid-item col-8">
                <h2 class="card-title"><i class="fa-solid fa-shield-halved"></i>各大隊戰力雷達圖 (綜合評級分佈)</h2>
                <div id="radar-chart-container" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; min-height:300px;"></div>
            </div>
            <div class="grid-item col-4">
                <h2 class="card-title"><i class="fa-solid fa-users"></i>受測人員年齡與性別分佈</h2>
                <div id="age-chart-container" class="chart-container-inner"><canvas id="ageChart"></canvas></div>
            </div>
            <div class="grid-item col-4" id="leaderboard-table">
                <h2 class="card-title" id="leaderboard-title"></h2>
                <div style="overflow-y:auto; max-height:400px;">
                    <table class="data-table">
                        <thead><tr><th>排名</th><th>姓名</th><th>大隊</th><th>成績</th><th>綜合評級</th></tr></thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="grid-item col-8" id="comparison-chart-container">
                <h2 class="card-title" id="comparison-title"></h2>
                 <div class="chart-container-inner"><canvas id="comparisonChart"></canvas></div>
            </div>
        </section>
    </div>

<script>
// --- CLIENT-SIDE PROCESSING ENGINE ---
document.getElementById('process-button').addEventListener('click', () => {
    const inputCSV = document.getElementById('input-data').value;
    const conversionCSV = document.getElementById('conversion-data').value;
    if (!inputCSV || !conversionCSV) {
        alert('請確認兩個文字框都已貼上CSV內容。');
        return;
    }
    
    // --- 1. PARSE & PREPARE DATA ---
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
            const values = line.split(',');
            let obj = {};
            headers.forEach((header, i) => obj[header] = values[i] ? values[i].trim() : '');
            return obj;
        });
    }

    const df_input = parseCSV(inputCSV);
    const df_conversion = parseCSV(conversionCSV);

    function timeToSeconds(timeStr) {
        if (!timeStr) return NaN;
        timeStr = timeStr.replace(/"/g, '').replace(/'/g, ':');
        if (timeStr.includes(':')) {
            const parts = timeStr.split(':').map(Number);
            return parts[0] * 60 + parts[1];
        }
        return parseFloat(timeStr);
    }
    
    const testItemsProps = {
        '1500公尺跑走': { type: 'time', unit: '秒', displayName: '1500M跑走' },
        '單槓引體向上': { type: 'reps', unit: '次', displayName: '單槓引體向上' },
        '伏地挺身': { type: 'reps', unit: '次', displayName: '伏地挺身' },
        '負重體能(男)': { type: 'time', unit: '秒', displayName: '負重體能(男)' },
        '負重體能(女)': { type: 'time', unit: '秒', displayName: '負重體能(女)' },
        '折返跑': { type: 'time', unit: '秒', displayName: '折返跑' },
        '六角槓負重硬舉': { type: 'reps', unit: '次', displayName: '六角槓硬舉' }
    };
    const activeTestItems = Object.keys(testItemsProps).filter(key => df_input[0].hasOwnProperty(key));
    
    df_input.forEach(row => {
        activeTestItems.forEach(item => {
            row[item] = testItemsProps[item].type === 'time' ? timeToSeconds(row[item]) : parseFloat(row[item]);
        });
        row['年齡'] = parseInt(row['年齡']);
    });
    
    df_conversion.forEach(rule => {
        rule['次/秒數(起)'] = parseFloat(rule['次/秒數(起)']);
        rule['次/秒數(迄)'] = parseFloat(rule['次/秒數(迄)']) || rule['次/秒數(起)'];
        rule['分數'] = parseInt(rule['分數']);
    });

    // --- 2. CALCULATION ENGINE ---
    function getAgeGroup(age) {
        if (age >= 50) return "50歲以上";
        if (age >= 45) return "45-49歲";
        if (age >= 40) return "40-44歲";
        if (age >= 35) return "35-39歲";
        if (age >= 30) return "30-34歲";
        if (age >= 25) return "25-29歲";
        return "20-24歲";
    }
    df_input.forEach(row => row['年齡級距'] = getAgeGroup(row['年齡']));
    
    function getScore(row, itemName) {
        const performance = row[itemName];
        if (isNaN(performance)) return 0;
        const lookupName = itemName.includes('負重體能') ? '負重體能' : itemName;
        const rules = df_conversion.filter(r => r['項目'] === lookupName && r['性別'] === row['性別'] && r['年齡級距'] === row['年齡級距']);
        for (const rule of rules) {
            if (performance >= rule['次/秒數(起)'] && performance <= rule['次/秒數(迄)']) return rule['分數'];
        }
        return 0;
    }
    
    df_input.forEach(row => {
        let totalScore = 0;
        activeTestItems.forEach(item => {
            const score = getScore(row, item);
            row[`${item}_分數`] = score;
            totalScore += score;
        });
        row['總分'] = totalScore;
    });

    const maxScore = activeTestItems.length * 100;
    function getGrade(totalScore) {
        if (totalScore >= maxScore * 0.9) return "菁英級";
        if (totalScore >= maxScore * 0.75) return "良好級";
        if (totalScore >= maxScore * 0.6) return "合格級";
        return "待加強";
    }
    const gradeMap = {"菁英級": "excellent", "良好級": "good", "合格級": "pass", "待加強": "fail"};
    df_input.forEach(row => {
        row['等級'] = getGrade(row['總分']);
        row['等級CSS'] = gradeMap[row['等級']];
    });

    // --- 3. AGGREGATE DATA ---
    const totalPersonnel = df_input.length;
    let gradeCounts = { '菁英級': 0, '良好級': 0, '合格級': 0, '待加強': 0 };
    df_input.forEach(row => gradeCounts[row['等級']]++);

    const dashboardData = {
        kpi: {
            excellent: { percentage: Math.round(gradeCounts['菁英級'] / totalPersonnel * 100), count: gradeCounts['菁英級'] },
            good: { percentage: Math.round(gradeCounts['良好級'] / totalPersonnel * 100), count: gradeCounts['良好級'] },
            pass: { percentage: Math.round(gradeCounts['合格級'] / totalPersonnel * 100), count: gradeCounts['合格級'] },
            fail: { percentage: Math.round(gradeCounts['待加強'] / totalPersonnel * 100), count: gradeCounts['待加強'] }
        },
        radar: {},
        age_distribution: {},
        detailed_analysis: {}
    };
    
    const battalions = [...new Set(df_input.map(r => r['大隊']))].sort();
    battalions.forEach(b => {
        const b_df = df_input.filter(r => r['大隊'] === b);
        let b_grade_counts = { '菁英級': 0, '良好級': 0, '合格級': 0, '待加強': 0 };
        b_df.forEach(row => b_grade_counts[row['等級']]++);
        dashboardData.radar[b] = {
            total: b_df.length,
            distribution: [
                Math.round(b_grade_counts['菁英級'] / b_df.length * 100),
                Math.round(b_grade_counts['良好級'] / b_df.length * 100),
                Math.round(b_grade_counts['合格級'] / b_df.length * 100),
                Math.round(b_grade_counts['待加強'] / b_df.length * 100)
            ]
        };
    });
    
    activeTestItems.forEach(item => {
        const isTime = testItemsProps[item].type === 'time';
        df_input.sort((a, b) => isTime ? (a[item] - b[item]) : (b[item] - a[item]));
        const leaderboard = df_input.slice(0, 5).map((row, i) => {
            let res_str = 'N/A';
            if (!isNaN(row[item])) {
                res_str = isTime ? `${Math.floor(row[item] / 60)}'${String(row[item] % 60).padStart(2, '0')}"` : String(row[item]);
            }
            return { rank: i + 1, name: row['姓名'], battalion: row['大隊'], result: res_str, grade: row['等級'], gradeClass: row['等級CSS'] };
        });
        
        let averages = {};
        battalions.forEach(b => {
            const b_df = df_input.filter(r => r['大隊'] === b && !isNaN(r[item]));
            const avg = b_df.length ? b_df.reduce((sum, r) => sum + r[item], 0) / b_df.length : 0;
            averages[b] = isTime ? (avg / 60) : avg;
        });

        dashboardData.detailed_analysis[item] = {
            unit: isTime ? '分鐘' : '次',
            displayName: testItemsProps[item].displayName,
            comparison: { labels: Object.keys(averages), averages: Object.values(averages).map(v => Math.round(v*100)/100) },
            leaderboard: leaderboard
        };
    });
    
    // --- 4. RENDER DASHBOARD ---
    const dashboardElement = document.getElementById('dashboard');
    dashboardElement.style.display = 'grid';
    window.scrollTo({ top: document.getElementById('dashboard').offsetTop - 20, behavior: 'smooth' });
    
    let chartInstances = {};
    function destroyCharts() {
        Object.values(chartInstances).forEach(chart => { if(chart) chart.destroy(); });
        chartInstances = {};
    }
    destroyCharts();
    
    document.getElementById('kpi-excellent').textContent = `${dashboardData.kpi.excellent.percentage}% (${dashboardData.kpi.excellent.count}人)`;
    document.getElementById('kpi-good').textContent = `${dashboardData.kpi.good.percentage}% (${dashboardData.kpi.good.count}人)`;
    document.getElementById('kpi-pass').textContent = `${dashboardData.kpi.pass.percentage}% (${dashboardData.kpi.pass.count}人)`;
    document.getElementById('kpi-fail').textContent = `${dashboardData.kpi.fail.percentage}% (${dashboardData.kpi.fail.count}人)`;

    const radarContainer = document.getElementById('radar-chart-container');
    radarContainer.innerHTML = '';
    const radarColors = ['#1890ff', '#26c6da', '#ffca28', '#ff7043'];
    battalions.forEach((name, i) => {
        const chartDiv = document.createElement('div');
        const canvas = document.createElement('canvas');
        chartDiv.appendChild(canvas);
        radarContainer.appendChild(chartDiv);
        const data = dashboardData.radar[name];
        chartInstances[`radar_${name}`] = new Chart(canvas, {
            type: 'radar',
            data: {
                labels: ['菁英級', '良好級', '合格級', '待加強'],
                datasets: [{ label: name, data: data.distribution, borderColor: radarColors[i % 4], backgroundColor: radarColors[i % 4].replace(')', ', 0.2)').replace('#', 'rgba(') }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' } } }
        });
    });

    const testSelect = document.getElementById('test-select');
    testSelect.innerHTML = '';
    activeTestItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = testItemsProps[item].displayName;
        testSelect.appendChild(option);
    });
    
    function updateDetailedCharts(selectedTest) {
        const data = dashboardData.detailed_analysis[selectedTest];
        document.getElementById('leaderboard-title').innerHTML = `<i class="fa-solid fa-medal"></i> ${data.displayName} 成績菁英榜`;
        document.getElementById('leaderboard-body').innerHTML = data.leaderboard.map(p => `<tr><td>${p.rank}</td><td>${p.name}</td><td>${p.battalion}</td><td>${p.result}</td><td><span class="badge ${p.gradeClass}">${p.grade}</span></td></tr>`).join('');
        document.getElementById('comparison-title').innerHTML = `<i class="fa-solid fa-chart-column"></i> ${data.displayName} 各大隊平均成績`;
        
        if (chartInstances.comparison) chartInstances.comparison.destroy();
        chartInstances.comparison = new Chart(document.getElementById('comparisonChart'), {
            type: 'bar',
            data: {
                labels: data.comparison.labels,
                datasets: [{ data: data.comparison.averages, backgroundColor: radarColors }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: v => v } },
                scales: { y: { title: { display: true, text: `平均 (${data.unit})` } } }
            },
            plugins: [ChartDataLabels]
        });
    }

    updateDetailedCharts(testSelect.value);
    testSelect.onchange = (e) => updateDetailedCharts(e.target.value);
});
</script>
</body>
</html>
